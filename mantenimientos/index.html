<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema de Mantenimiento - IT Solutions</title>

  <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />


<style>
    
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body, html {
      height: 100%;
      width: 100%;
      overflow-x: hidden;
    }

    
    #video-fondo {
      position: fixed;
      top: 0;
      left: 0;
      min-width: 100%;
      min-height: 100%;
      object-fit: cover;
      z-index: -1;
      display: none;
    }

    
    .login-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .login-box {
      background: rgba(221, 229, 252, 0.85);
      padding: 2.5rem;
      border-radius: 10px;
      box-shadow: 0 15px 35px rgba(250, 4, 4, 0.3);
      width: 100%;
      max-width: 400px;
      text-align: center;
      backdrop-filter: blur(5px);
    }

    .login-box h2 {
      color: #2a5298;
      margin-bottom: 1.5rem;
      font-weight: 2000;
    }

    .login-box input {
      width: 100%;
      padding: 12px 15px;
      margin-bottom: 1rem;
      border: 1px solid #2c0ce0;
      border-radius: 5px;
      font-size: 14px;
      transition: border 0.3s;
      background: rgba(255, 255, 255, 0.8);
    }

    .login-box input:focus {
      border-color: #2a5298;
      outline: none;
    }

    .login-box button {
      width: 100%;
      padding: 12px;
      background-color: #2a5298;
      color: white;
      border: none;
      border-radius: 5px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    .login-box button:hover {
      background-color: #1e3c72;
    }

    #error-login {
      color: #f71b03;
      margin-top: 1rem;
      font-size: 14px;
      min-height: 20px;
    }

    /* Estilos para la aplicaci√≥n */
    #app {
      display: none;
      padding: 20px;
      max-width: 1200px;
      margin: 0 auto;
      min-height: 100vh;
      background: #f5f7fa;
    }

    /* Barra de navegaci√≥n */
    .app-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid #ddd;
    }

    .app-title h1 {
      color: #2a5298;
      font-size: 1.8rem;
    }

    .app-title p {
      color: #666;
      font-size: 0.9rem;
    }

    .nav-buttons {
      display: flex;
      gap: 10px;
    }

    .nav-buttons button {
      padding: 8px 16px;
      background-color: #2a5298;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    .nav-buttons button:hover {
      background-color: #1e3c72;
    }

    .logout-btn {
      background-color: #e74c3c !important;
    }

    .logout-btn:hover {
      background-color: #c0392b "üö™" !important;
    }

    /* Resumen de estad√≠sticas */
    .stats-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 2rem;
    }

    .stat-card {
      background: white;
      padding: 1.5rem;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      text-align: center;
      transition: transform 0.3s;
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }

    .stat-card h3 {
      color: #666;
      font-size: 1rem;
      margin-bottom: 0.5rem;
    }

    .stat-card p {
      color: #2a5298;
      font-size: 1.8rem;
      font-weight: 600;
    }

    /* Formulario de registro */
    #registrar {
      background: white;
      padding: 2rem;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      margin-bottom: 2rem;
    }

    #registrar h2 {
      color: #2a5298;
      margin-bottom: 1.5rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid #eee;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 15px;
      margin-bottom: 1.5rem;
    }

    .form-group {
      margin-bottom: 1rem;
    }

    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      color: #555;
      font-size: 0.9rem;
      font-weight: 500;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 14px;
      transition: border 0.3s;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      border-color: #2a5298;
      outline: none;
      box-shadow: 0 0 0 2px rgba(42, 82, 152, 0.1);
    }

    .form-group textarea {
      min-height: 100px;
      resize: vertical;
    }

    .form-actions {
      text-align: right;
      margin-top: 1rem;
    }

    .form-actions button {
      padding: 10px 20px;
      background-color: #2a5298;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.3s;
      font-weight: 500;
    }

    .form-actions button:hover {
      background-color: #1e3c72;
    }

    /* Lista de registros */
    #lista {
      list-style: none;
    }

    .registro-item {
      background: rgb(232, 240, 243);
      padding: 1.5rem;
      margin-bottom: 1rem;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      transition: transform 0.3s, box-shadow 0.3s;
    }

    .registro-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }

    .registro-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid #eee;
    }

    .registro-title {
      font-weight: 600;
      color: #2a5298;
      font-size: 1.1rem;
    }

    .registro-actions {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .registro-actions button {
      padding: 5px 10px;
      font-size: 0.8rem;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: opacity 0.3s;
    }

    .registro-actions button:hover {
      opacity: 0.9;
    }

    .edit-btn {
      background-color: #3498db;
      color: white;
    }

    .delete-btn {
      background-color: #e74c3c;
      color: white;
    }

    .registro-details {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 15px;
    }

    .detail-item {
      margin-bottom: 0.5rem;
    }

    .detail-label {
      font-size: 0.8rem;
      color: #777;
      font-weight: 500;
    }

    .detail-value {
      font-size: 0.9rem;
      color: #333;
      word-break: break-word;
    }

    /* Secci√≥n de b√∫squeda */
    #buscar {
      display: none;
      background: white;
      padding: 2rem;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    #buscar h2 {
      color: hsl(218, 33%, 57%);
      margin-bottom: 1.5rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid #eee;
    }

    .search-controls {
      display: flex;
      gap: 15px;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
    }

    .search-controls input {
      flex: 1;
      min-width: 200px;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 14px;
    }

    .search-controls button {
      padding: 10px 20px;
      background-color: #2a5298;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: 500;
    }

    .search-controls button:hover {
      background-color: #1e3c72;
    }

    .date-filters {
      display: flex;
      gap: 15px;
      margin-bottom: 1.5rem;
      align-items: center;
      flex-wrap: wrap;
    }

    .date-filters label {
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 0.9rem;
      color: #555;
    }

    .date-filters input {
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 5px;
    }

  /* Modales */
.modal {
  position: fixed;
  inset: 0; /* reemplaza top/left/width/height */
  background: rgba(0, 0, 0, 0.5);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 1000;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s ease; /* transici√≥n suave */
}

.modal.active {
  opacity: 1;
  pointer-events: all;
}

.modal-content {
  background: white;
  padding: 2rem;
  border-radius: 8px;
  width: 90%;
  max-width: 600px;
  max-height: 90vh;
  overflow-y: auto;
  position: relative;
  box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
  animation: modalEntrada 0.25s ease;
}

/* Animaci√≥n de entrada */
@keyframes modalEntrada {
  from { transform: translateY(-20px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}

    #historial-contenido {
  margin-top: 1rem;
  max-height: 60vh;
  overflow-y: auto;
}
.close-modal-historial {
  position: absolute;
  top: 12px;
  right: 12px;
  background: none;
  border: none;
  cursor: pointer;
  padding: 0;
  z-index: 10;
  transition: transform 0.2s ease;
}

.close-modal-historial svg {
  display: block;
  transition: transform 0.3s ease;
}

.close-modal-historial:hover svg {
  transform: scale(1.1);
}

.close-modal-historial svg circle {
  transition: fill 0.3s ease;
}

.close-modal-historial:hover svg circle {
  fill: #c0392b; /* Color m√°s oscuro al hacer hover */
}


    .close-modal:hover {
      color: #333;
    }

    /* Estado de los registros */
    .status-badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 500;
    }

    .status-pendiente {
      background-color: #f39c12;
      color: white;
    }

    .status-progreso {
      background-color: #3498db;
      color: white;
    }

    .status-finalizado {
      background-color: #2ecc71;
      color: white;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .login-box {
        padding: 1.5rem;
        margin: 0 15px;
      }

      .form-grid {
        grid-template-columns: 1fr;
      }

      .registro-details {
        grid-template-columns: 1fr;
      }

      .stats-container {
        grid-template-columns: 1fr 1fr;
      }

      .app-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 15px;
      }

      .nav-buttons {
        width: 100%;
        justify-content: space-between;
      }

      .modal-content {
        padding: 1.5rem;
      }
    }

    @media (max-width: 480px) {
      .login-box {
        padding: 1.2rem;
      }

      .stats-container {
        grid-template-columns: 1fr;
      }

      .date-filters {
        flex-direction: column;
        align-items: flex-start;
      }
    }
    .titulo-con-imagen {
  position: relative;
  display: inline-block;
  padding: 1rem 2rem;
  z-index: 0;
}

.titulo-con-imagen h1 {
  position: relative;
  z-index: 2;
  padding-left: 150px;
  color: #2a0591; /* o blanco si lo necesitas encima de imagen oscura */
}
.titulo-con-imagen p {
  position: relative;
  z-index: 2;
  padding-left: 150px;
  color: #0c0324; /* o blanco si lo necesitas encima de imagen oscura */
}

.titulo-con-imagen::before {
  content: "";
  position: absolute;
  top: -40px; 
  margin-left: -80px;
  width: 230px;               /* Mismo ancho */
  height: 220px;              /* que el alto (c√≠rculo) */
  background-image: url('VIDEO/logo-aliar.png'); /* Ruta de tu imagen */
  background-size: cover;    /* Asegura que llene el c√≠rculo */
  background-repeat: no-repeat;
  background-position: center;
  border-radius: 50%;        /* Hace que sea redonda */
  z-index: 1;
  pointer-events: none;
}
.nav-buttons-container {
  position: relative;
  display: flex;
  justify-content: flex-end;
  align-items: center;
  padding-right: 1rem;
}

.choices__item--choice {
  white-space: nowrap;       /* Evita salto de l√≠nea */
  overflow: hidden;          /* Oculta texto que se desborde */
  max-width: 250%;           /* Limita al ancho del contenedor */
}

.mensaje-vacio {
  color: #e74c3c;         /* Rojo moderno */
  text-align: center;
  font-weight: bold;
  font-size: 1rem;
  margin-top: 1rem;
}
.titulo-animado {
  opacity: 0;
  transform: translateY(20px);
  animation: aparecer 1.5s ease-out forwards;
  animation-delay: 0.5s;
}

.parrafo-animado {
  opacity: 0;
  transform: translateY(20px);
  animation: aparecer 1.5s ease-out forwards;
  animation-delay: 1s;
}

@keyframes aparecer {
  to {
    opacity: 1;
    transform: translateY(0);
  }
}
.titulo-animado {
  opacity: 0;
  transform: translateY(20px);
  animation: aparecer 1.5s ease-out forwards;
  animation-delay: 0.5s;
  font-size: 2rem;
  color: #0a0a23;
  font-weight: 800;
  margin-bottom: 0.5rem;
  letter-spacing: 1px;
}

.parrafo-animado {
  opacity: 0;
  transform: translateY(20px);
  animation: aparecer 1.5s ease-out forwards;
  animation-delay: 1s;
  font-size: 1rem;
  color: #333;
  font-weight: 600;
  margin-bottom: 1.5rem;
}

.alerta-sistema {
  font-size: 0.85rem;
  color: #792020;
  font-weight: 600;
  margin-top: 1rem;
}

@keyframes aparecer {
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.alerta-sistema {
  font-size: 0.85rem;
  color: #792020;
  font-weight: 600;
  margin-top: 1rem;
  background-color: #ffe5e5;
  padding: 10px;
  border-radius: 5px;
  transition: opacity 1s ease, transform 1s ease;
}

.alerta-oculta {
  opacity: 0;
  transform: translateY(-10px);
  pointer-events: none;
}
.error-login {
  color: #721c24;
  background-color: #f8d7da;
  border: 1px solid #f5c6cb;
  padding: 10px;
  margin-top: 1rem;
  font-weight: bold;
  border-radius: 5px;
  text-align: center;
  opacity: 0;
  transform: translateY(-10px);
  transition: opacity 0.5s ease, transform 0.5s ease;
}

.error-login.visible {
  opacity: 1;
  transform: translateY(0);
}

.error-login.oculto {
  display: none;
}
.login-box {
  position: relative;
  background: rgba(221, 229, 252, 0.85);
  padding: 2.5rem;
  border-radius: 10px;
  box-shadow: 0 15px 35px rgba(250, 4, 4, 0.3);
  width: 100%;
  max-width: 400px;
  text-align: center;
  backdrop-filter: blur(5px);
  overflow: hidden;
}

/* L√≠nea luminosa que recorre los bordes */
.esquinas-luz {
  content: "";
  position: absolute;
  width: 100%;
  height: 100%;
  border-radius: 10px;
  pointer-events: none;
  z-index: 0;
}

.esquinas-luz::before {
  content: "";
  position: absolute;
  width: 60px;
  height: 4px;
  background: #00f0ff;
  box-shadow: 0 0 10px #00f0ff, 0 0 20px #00f0ff;
  animation: recorrer-bordes 8s linear infinite;
}

@keyframes recorrer-bordes {
  0% {
    top: 0;
    left: 0;
    transform: rotate(0deg);
  }
  25% {
    top: 0;
    left: 100%;
    transform: rotate(90deg);
  }
  50% {
    top: 100%;
    left: 100%;
    transform: rotate(180deg);
  }
  75% {
    top: 100%;
    left: 0;
    transform: rotate(270deg);
  }
  100% {
    top: 0;
    left: 0;
    transform: rotate(360deg);
  }
}
.emoji-rebotando {
  position: absolute;
  font-size: 20px;
  z-index: 0;
  pointer-events: none;
  animation: brillo 1s infinite alternate;
}

@keyframes brillo {
  0% {
    filter: drop-shadow(0 0 3px #00f0ff);
  }
  100% {
    filter: drop-shadow(0 0 10px #00f0ff);
  }
}
/* Contenedor centrado */
.sede-wrapper{
  margin-top: 8px;
  display:flex;
  justify-content:center;
}

/* Badge de la sede */
.sede-badge{
  display:inline-block;
  padding: .35rem .8rem;
  border-radius: 9999px;              
  font-weight: 700;
  font-size: .98rem;
  letter-spacing: .3px;
  color: #0a0a23;
  background: linear-gradient(180deg, #f3f7ff, #e7eefc);
  box-shadow: 0 3px 12px rgba(10,10,35,.08), inset 0 0 0 1px rgba(10,10,35,.05);
}


.sede-animado{
  opacity: 0;
  transform: translateY(10px) scale(.98);
  animation: aparecer .9s ease-out forwards;
  animation-delay: 1.3s; 
}


.sede-badge:hover{
  box-shadow: 0 6px 16px rgba(10,10,35,.12), inset 0 0 0 1px rgba(10,10,35,.08);
}


.sede-wrapper {
  margin-top: 8px;
  display: flex;
  justify-content: flex-end; 
  position: absolute;
  top: -10px;    
  right: -370px; 
  z-index: 2;
}


.sede-badge {
  display: inline-block;
  padding: .35rem .8rem;
  border-radius: 9999px;              
  font-weight: 700;
  font-size: .98rem;
  letter-spacing: .3px;
  color: #0a0a23;
  background: linear-gradient(180deg, #f3f7ff, #e7eefc);
  box-shadow: 0 3px 12px rgba(10,10,35,.08), 
              inset 0 0 0 1px rgba(10,10,35,.05);
}


.sede-animado {
  opacity: 0;
  transform: translateY(10px) scale(.98);
  animation: aparecer .9s ease-out forwards;
  animation-delay: 1.3s; 
}


.sede-badge:hover {
  box-shadow: 0 6px 16px rgba(10,10,35,.12), 
              inset 0 0 0 1px rgba(10,10,35,.08);
}


@keyframes aparecer {
  to {
    opacity: 1;
    transform: translateY(0) scale(1);
  }
}
.sede-animado {
  opacity: 0;
  transform: translateY(10px) scale(.98);
  animation: aparecer .9s ease-out forwards;
  animation-delay: 1.3s; 
}

@keyframes aparecer {
  to {
    opacity: 1;
    transform: translateY(0) scale(1);
  }
}



  </style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
  
  <video id="video-fondo" autoplay muted loop>
    <source src="VIDEO/VIDEO-MP4.mp4" type="video/mp4">
    Tu navegador no soporta video.
  </video>

 
  <div class="login-container" id="login">
  <div class="login-box">
    <span class="esquinas-luz"></span>
    <span class="emoji-rebotando" id="emoji-rebotando">üõ†Ô∏è</span>
    <h2 class="titulo-animado">
      üõ†Ô∏è Mantenimientos Tecnolog√≠a
    </h2>
    <p class="parrafo-animado">
      Ingrese sus credenciales para acceder
    </p>

    <form id="login-form">
      <input type="text" id="usuario" placeholder="Usuario" required>
      <input type="password" id="clave" placeholder="Contrase√±a" required>
      <button type="submit">Iniciar Sesi√≥n</button>
<p class="alerta-sistema" id="alerta-sistema">
  ‚ö†Ô∏è Esta p√°gina est√° siendo supervisada por los administradores del sistema.
</p>

    <p id="error-login" class="error-login oculto"></p>

    </form>
  </div>
</div>

  
  <div id="app">
    <header class="app-header">
      <div class="titulo-con-imagen">
        <h1 class="titulo-animado">Mantenimiento Tecnol√≥gicosüíªüì°</h1>
<p class="parrafo-animado">‚öôRegistros de equipos inform√°ticos</p>
<div class="sede-wrapper">
  <span id="nombreSede" class="sede-badge sede-animado"></span>
</div>

     <div style="width: 240%; display: flex; justify-content: center;" class="sede-animado">
  <p style="color: rgb(206, 214, 200); font-weight: bold; font-size: 1.1rem; margin: 0;">
    Creador: Carlos Escobar_Pasante.tecnologia_meta
  </p>

</div>
</div>
<div class="nav-buttons-container">
  <div class="nav-buttons">
    <button id="btn-registrar">Nuevo Registro</button>
    <button id="btn-buscar">Buscar</button>
    <button id="btn-logout" class="logout-btn">üö™Cerrar Sesi√≥n</button>
  </div>
</div>

</header>


    <div class="stats-container">
      <div class="stat-card" onclick="verTodosLosRegistros()">
        <h3>Total Registros</h3>
        <p id="total">0</p>
      </div>
      <div class="stat-card" onclick="verPendientes()">
        <h3>Pendientes</h3>
        <p id="pendientes">0</p>
      </div>
      <div class="stat-card" onclick="verEnProgreso()">
        <h3>En Progreso</h3>
        <p id="en-progreso">0</p>
      </div>
     <div class="stat-card" onclick="verFinalizados()">
        <h3>Finalizados</h3>
        <p id="finalizados">0</p>
      </div>
    </div>

  
   
<section id="registrar">
  <h2>Registrar Nuevo Mantenimiento</h2>
  <form id="form-registro">
    <div class="form-grid">

      <div class="form-group">
        <label for="tipo">Tipo de Equipo</label>
        <select id="tipo" name="tipo" required></select>
      </div>

      <div class="form-group">
        <label for="placa">Placa/Identificaci√≥n</label>
        <input type="text" id="placa" name="placa" required>
      </div>

      <div class="form-group">
        <label for="marca">Marca</label>
        <select id="marca" name="marca" required></select>
      </div>

      <div class="form-group">
        <label for="modelo">Modelo</label>
        <select id="modelo" name="modelo" required></select>
      </div>

      <div class="form-group">
        <label for="serial">N√∫mero de Serie</label>
        <input type="text" id="serial" name="serial" required>
      </div>

      <div class="form-group">
        <label for="fecha">Fecha</label>
        <input type="date" id="fecha" name="fecha" required>
      </div>

      <div class="form-group">
        <label for="tecnico">T√©cnico Responsable</label>
      <select id="tecnico" name="tecnico"></select>


      </div>

      <div class="form-group">
        <label for="tipo_mantenimiento">Tipo de Mantenimiento</label>
        <select id="tipo_mantenimiento" name="tipo_mantenimiento" required></select>
      </div>

      <div class="form-group">
        <label for="estado">Estado</label>
        <select id="estado" name="estado" required></select>
      </div>

      <div class="form-group">
        <label for="ubicacion">Ubicaci√≥n</label>
        <select id="ubicacion" name="ubicacion" required></select>
      </div>

      <div class="form-group">
        <label for="centro-costo">Centro de Costo</label>
        <input type="text" id="centro-costo" name="centro_costo" required>
      </div>

      <div class="form-group">
        <label for="url-ticket">URL del Ticket (opcional)</label>
        <input type="url" id="url-ticket" name="url_ticket">
      </div>

    </div>

    <div class="form-group">
      <label for="observaciones">Observaciones</label>
      <textarea id="observaciones" name="observaciones"></textarea>
    </div>

    <div class="form-actions">
      <button type="submit">Guardar Registro</button>
    </div>
  </form>

  <ul id="lista" style="margin-top: 2rem;"></ul>
</section>


     
      <ul id="lista" style="margin-top: 2rem;"></ul>
    </section>

    
    <section id="buscar">
      <h2>Buscar Mantenimientos</h2>
      <div class="search-controls">
        <input type="text" id="buscar-input" placeholder="Buscar por placa, serial o t√©cnico...">
        <button id="btn-ejecutar-busqueda">Buscar Registro</button>
        <button id="exportar-excel">Exportar a Excel</button>
      </div>
      <div class="date-filters">
        <label>
          Desde:
          <input type="date" id="filtro-desde">
        </label>
        <label>
          Hasta:
          <input type="date" id="filtro-hasta">
        </label>
        <button id="filtrar-fechas">Filtrar</button>
      </div>
      <ul id="resultados" style="margin-top: 1.5rem;"></ul>
    </section>
  </div>

  
<div class="modal" id="modal-edicion">
  <div class="modal-content">
    <span class="close-modal">&times;</span>
    <h3>Editar Mantenimiento</h3>
    <form id="form-edicion">
      <div class="form-grid">

        
        <div class="form-group">
          <label for="edit-placa">Placa / Identificaci√≥n</label>
          <input type="text" id="edit-placa" required>
        </div>

        <div class="form-group">
          <label for="edit-serial">Serial</label>
          <input type="text" id="edit-serial" required>
        </div>

        <div class="form-group">
          <label for="edit-fecha">Fecha</label>
          <input type="date" id="edit-fecha" required>
        </div>

        
        <div class="form-group">
          <label for="edit-tipo">Tipo de Equipo</label>
          <select id="edit-tipo" required></select>
        </div>

        <div class="form-group">
          <label for="edit-marca">Marca</label>
          <select id="edit-marca" required></select>
        </div>

        <div class="form-group">
          <label for="edit-modelo">Modelo</label>
          <select id="edit-modelo" required></select>
        </div>

        <div class="form-group">
          <label for="edit-tecnico">T√©cnico Responsable</label>
          <select id="edit-tecnico" name="tecnico" required></select>
        </div>

        <div class="form-group">
          <label for="edit-tipo-mantenimiento">Tipo de Mantenimiento</label>
         <select id="edit-tipo-mantenimiento" name="tipo_mantenimiento" required></select>
           </div>

        <div class="form-group">
          <label for="edit-estado">Estado</label>
          <select id="edit-estado" required></select>
        </div>

        <div class="form-group">
          <label for="edit-ubicacion">Ubicaci√≥n</label>
          <select id="edit-ubicacion" required></select>
        </div>

        
       <div class="form-group">
  <label for="edit-centro-costo">Centro de Costo</label>
  <input type="text" id="edit-centro-costo" name="centro_costo" required>
</div>


<div class="form-group">
  <label for="edit-url-ticket">URL del Ticket</label>
  <input type="url" id="edit-url-ticket" name="url_ticket">
</div>
      </div>

      <div class="form-group">
        <label for="edit-observaciones">Observaciones</label>
        <textarea id="edit-observaciones"></textarea>
      </div>

      <input type="hidden" id="edit-indice">

      <div class="form-actions">
        <button type="submit">Guardar Cambios</button>
      </div>
    </form>
  </div>
</div>


 <script>
  
const API_BASE = "http://10.110.6.148/mantenimientos/";
</script>


 <script>




const selectsEdicion = {
  'edit-tipo': 'listar_tipo_equipo.php',
  'edit-marca': 'listar_marcas.php',
  'edit-modelo': 'listar_modelos.php',
  'edit-tecnico': 'listar_tecnicos.php',
  'edit-tipo-mantenimiento': 'listar_tipos_mantenimiento.php',
  'edit-estado': 'listar_estados.php',
  'edit-ubicacion': 'listar_ubicaciones.php'
};


function aplicarChoices(select) {
  if (!select.classList.contains('choices-initialized')) {
    new Choices(select, {
      placeholderValue: 'Seleccionar...',
      searchPlaceholderValue: 'Buscar...',
      searchEnabled: true,
      removeItemButton: true,
      shouldSort: false
    });
    select.classList.add('choices-initialized');
  }
}


function cargarSelect(idSelect, endpoint, valorActual = '') {
  const select = document.getElementById(idSelect);
  if (!select) return Promise.resolve();

  return fetch(API_BASE + endpoint)
    .then(res => res.json())
    .then(data => {
      select.innerHTML = '';
      const placeholder = new Option('Seleccionar...', '', true, true);
      placeholder.disabled = true;
      select.appendChild(placeholder);

      
      (Array.isArray(data) ? data : []).forEach(item => {
        select.appendChild(new Option(item, item));
      });

      
function asegurarOpcion(select, valor) {
  if (!valor) return;
  const existe = [...select.options].some(o => o.value === valor);
  if (!existe) {
    select.appendChild(new Option(valor, valor));
  }
}

     
      if (valorActual) {
        select.value = valorActual;
      }

      
      aplicarChoices(select);

      
      if (valorActual && select.value !== valorActual) {
        select.value = valorActual;
      }
    })
    .catch(err => console.error(`‚ùå Error cargando ${idSelect}:`, err));
}


function cargarSelectsEdicion(valores = {}) {
  return Promise.all(
    Object.entries(selectsEdicion).map(([id, endpoint]) => {
      const clave = id.replace(/^edit-/, '').replace(/-/g, '_');
      const valorActual = (valores[clave] ?? '').toString().trim();
      return cargarSelect(id, endpoint, valorActual);
    })
  );
}


const clean = v => (v ?? '').toString().trim();

function parseFechaUI(a) {
  const meses = { ene:1,feb:2,mar:3,abr:4,may:5,jun:6,jul:7,ago:8,sep:9,oct:10,nov:11,dic:12 };
  const m = a?.toLowerCase().match(/(\d{1,2})\s+([a-z√±]{3})[a-z√±]*\s+(\d{4})/i);
  if (!m) return clean(a);
  const d = String(m[1]).padStart(2,'0');
  const mm = String(meses[m[2]] || 0).padStart(2,'0');
  return `${m[3]}-${mm}-${d}`;
}

window.abrirModalEdicion = (r) => {
  const registro = {
    ...r,
    placa: clean(r.placa),
    serial: clean(r.serial),
    fecha: parseFechaUI(r.fecha),

    
    centro_costo: clean(r.centro_costo ?? r.centroCosto ?? ''),
    url_ticket:   clean(r.url_ticket   ?? r.urlTicket   ?? ''),
    observaciones: clean(r.observaciones),

    
    tipo_mantenimiento: clean(r.tipo_mantenimiento ?? r.tipoMantenimiento ?? '')
  };

  document.getElementById('edit-placa').value = registro.placa || '';
  document.getElementById('edit-serial').value = registro.serial || '';
  document.getElementById('edit-fecha').value = registro.fecha || '';
  document.getElementById('edit-centro-costo').value = registro.centro_costo || '';
  document.getElementById('edit-url-ticket').value = registro.url_ticket || '';
  document.getElementById('edit-observaciones').value = registro.observaciones || '';
  document.getElementById('edit-indice').value = r.id || r.indice || '';

  cargarSelectsEdicion(registro).then(() => {
    document.getElementById('modal-edicion').classList.add('active');
  });
};

</script>


 
  <script>


 
  let registros = [];
  let currentSection = 'registrar';

  
  const loginContainer = document.getElementById('login');
  const appContainer = document.getElementById('app');
  const loginForm = document.getElementById('login-form');
  const errorLogin = document.getElementById('error-login');
  const btnRegistrar = document.getElementById('btn-registrar');
  const btnBuscar = document.getElementById('btn-buscar');
  const btnLogout = document.getElementById('btn-logout');
  const registrarSection = document.getElementById('registrar');
  const buscarSection = document.getElementById('buscar');
  const formRegistro = document.getElementById('form-registro');
  const listaRegistros = document.getElementById('lista');
  const buscarInput = document.getElementById('buscar-input');
  const resultadosBusqueda = document.getElementById('resultados');
  const exportarExcelBtn = document.getElementById('exportar-excel');
  const modalEdicion = document.getElementById('modal-edicion');
  const formEdicion = document.getElementById('form-edicion');
  const closeModal = document.querySelector('.close-modal');
  const totalElement = document.getElementById('total');
  const pendientesElement = document.getElementById('pendientes');
  const enProgresoElement = document.getElementById('en-progreso');
  const finalizadosElement = document.getElementById('finalizados');
  const videoFondo = document.getElementById('video-fondo');
  
window.editarRegistro = function (id) {
  const registro = registros.find(item => String(item.id) === String(id));

  if (!registro) {
    console.warn('No encontr√© el registro con id:', id);
    alert('No se encontr√≥ el registro para editar.');
    return;
  }

  console.log('Editando registro:', registro);
  abrirModalEdicion(registro); 
};

function toCamel(r) {
  if (!r || typeof r !== 'object') return r;
  const m = k => k.replace(/_([a-z])/g, (_,c) => c.toUpperCase());
  const out = {};
  for (const [k,v] of Object.entries(r)) out[m(k)] = v ?? '';
 
  const clean = x => {
    const s = String(x ?? '').trim();
    return (s === '' || s === '0' || s.toLowerCase() === 'null') ? '' : s;
  };
  out.tipoMantenimiento = clean(out.tipoMantenimiento);
  out.centroCosto       = clean(out.centroCosto);
  out.urlTicket         = clean(out.urlTicket);
  out.estado            = clean(out.estado);
  return out;
}


function toSnake(r) {
  const m = k => k.replace(/[A-Z]/g, c => '_' + c.toLowerCase());
  const out = {};
  for (const [k,v] of Object.entries(r)) out[m(k)] = v;
  return out;
}
async function sincronizarRegistros() {
  const ctrl = new AbortController();
  const timeoutMs = 15000;
  const t = setTimeout(() => ctrl.abort(), timeoutMs);

  try {
    const res = await fetch(API_BASE + "obtener_registros.php", {
      method: "GET",
      credentials: "include",            
      headers: { "Accept": "application/json" },
      signal: ctrl.signal                
    });

    const ctype = res.headers.get("content-type") || "";

    
    if (res.status === 401) {
      console.warn("Sesi√≥n expirada o no iniciada (401).");
      alert("‚ö†Ô∏è Tu sesi√≥n expir√≥. Por favor inicia sesi√≥n de nuevo.");
     
      return;
    }

   
    if (!res.ok) {
      let bodyText = "";
      try {
        if (ctype.includes("application/json")) {
          const j = await res.json();
          bodyText = j?.error || JSON.stringify(j);
        } else {
          bodyText = await res.text();
        }
      } catch (_) {
        
      }
      throw new Error(`HTTP ${res.status}${bodyText ? " - " + bodyText : ""}`);
    }

    
    let payload = [];
    if (ctype.includes("application/json")) {
      payload = await res.json();
    } else {
      payload = [];
    }

    
    const lista = Array.isArray(payload)
      ? payload
      : (Array.isArray(payload?.data) ? payload.data : []);

    
    registros = (lista || []).map(toCamel);

    
    if (currentSection === "registrar") {
      renderizarRegistros();
    } else {
      buscarRegistros();
    }
    actualizarEstadisticas();

  } catch (err) {
  
    if (err?.name === "AbortError") {
      console.error("Sincronizaci√≥n abortada por timeout:", err);
      alert("‚è≥ La solicitud tard√≥ demasiado. Intenta de nuevo.");
    } else {
      console.error("Error al sincronizar registros:", err);
      alert("‚ùå Error al sincronizar registros");
    }
  } finally {
    clearTimeout(t);
  }
}


    
   document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('btn-ejecutar-busqueda').addEventListener('click', () => {
    buscarRegistros();
  });

  



  videoFondo.style.display = 'block';

  
  const isLoggedIn = sessionStorage.getItem('isLoggedIn');
if (isLoggedIn === 'true') {
  videoFondo.style.display = 'none';
  loginContainer.style.display = 'none';
  appContainer.style.display = 'block';

  sincronizarRegistros(); 
}


  const today = new Date().toISOString().split('T')[0];
  document.getElementById('fecha').value = today;
  document.getElementById('filtro-desde').value = today;
  document.getElementById('filtro-hasta').value = today;


  setInterval(sincronizarRegistros, 30000);
});
document.getElementById('filtrar-fechas').addEventListener('click', () => {
  aplicarFiltroFecha = true;
  buscarRegistros();
});

   
    loginForm.addEventListener('submit', handleLogin);
    btnRegistrar.addEventListener('click', () => cambiarSeccion('registrar'));
    btnBuscar.addEventListener('click', () => cambiarSeccion('buscar'));
    btnLogout.addEventListener('click', handleLogout);
    formRegistro.addEventListener('submit', agregarRegistro);
    buscarInput.addEventListener('input', buscarRegistros);
    exportarExcelBtn.addEventListener('click', exportarAExcel);
    formEdicion.addEventListener('submit', guardarEdicion);
    closeModal.addEventListener('click', cerrarModal);

 


  function handleLogin(e) {
  e.preventDefault();
  const usuario = document.getElementById('usuario').value;
  const clave = document.getElementById('clave').value;
fetch("http://10.110.6.148/mantenimientos/validar_login.php", {



    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ usuario, clave })
  })
  .then(res => res.json())
  .then(data => {
  if (data.success) {
    
    if (data.role === 'admin') {
      window.location.href = "http://10.110.6.148/mantenimientos/ADMIN/panel_admin.php";
      return;
    }
    
    sessionStorage.setItem('isLoggedIn', 'true');
    loginContainer.style.display = 'none';
    appContainer.style.display = 'block';
    videoFondo.style.display = 'none';
    sincronizarRegistros();
  } else {
    errorLogin.textContent = data.error || "Usuario o contrase√±a no v√°lidos. Por favor, verifique sus datos";
    errorLogin.classList.remove('oculto');
    errorLogin.classList.add('visible');
    setTimeout(() => {
      errorLogin.classList.remove('visible');
      setTimeout(() => { errorLogin.classList.add('oculto'); }, 500);
    }, 5000);
  }

  })
  .catch(err => {
    console.error("Error en login:", err);
    errorLogin.textContent = "‚ùåError al conectar con el servidor";
  });
}

    function handleLogout() {
  videoFondo.style.display = 'block';
  sessionStorage.removeItem('isLoggedIn'); 
  loginContainer.style.display = 'flex';
  appContainer.style.display = 'none';
  document.getElementById('usuario').value = '';
  document.getElementById('clave').value = '';
  errorLogin.textContent = '';
}


    function cambiarSeccion(seccion) {
      if (seccion === currentSection) return;

      if (seccion === 'registrar') {
        registrarSection.style.display = 'block';
        buscarSection.style.display = 'none';
        currentSection = 'registrar';
      } else if (seccion === 'buscar') {
        registrarSection.style.display = 'none';
        buscarSection.style.display = 'block';
        buscarRegistros();
        currentSection = 'buscar';
      }
    }
function agregarRegistro(e) {
  e.preventDefault();

 
  const camposValidar = [
    { id: 'tipo', nombre: 'Tipo de Equipo' },
    { id: 'marca', nombre: 'Marca' },
    { id: 'modelo', nombre: 'Modelo' },
    { id: 'tecnico', nombre: 'T√©cnico Responsable' },
    { id: 'tipo_mantenimiento', nombre: 'Tipo de Mantenimiento' },
    { id: 'estado', nombre: 'Estado' },
    { id: 'ubicacion', nombre: 'Ubicaci√≥n' }
  ];

  for (let campo of camposValidar) {
    const select = document.getElementById(campo.id);
    if (!select || !select.value) {
      alert(`Por favor selecciona un valor para "${campo.nombre}".`);
      select?.focus();
      return;
    }
  }

  const nuevoRegistro = {
    id: Date.now().toString(),
    tipo: document.getElementById('tipo').value,
    placa: document.getElementById('placa').value,
    marca: document.getElementById('marca').value,
    modelo: document.getElementById('modelo').value,
    serial: document.getElementById('serial').value,
    fecha: document.getElementById('fecha').value,
    tecnico: document.getElementById('tecnico').value,
    tipoMantenimiento: document.getElementById('tipo_mantenimiento').value,
    estado: document.getElementById('estado').value,
    ubicacion: document.getElementById('ubicacion').value,
    centroCosto: document.getElementById('centro-costo').value,
    urlTicket: document.getElementById('url-ticket').value,
    observaciones: document.getElementById('observaciones').value,
    fechaRegistro: new Date().toISOString(),
    usuarioRegistro: document.getElementById('usuario')?.value || 'tecnico'
  };

  fetch(API_BASE + "guardar_registro.php", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(nuevoRegistro)
  })
    .then(res => res.json())
    .then(data => {
      console.log("Respuesta del servidor:", data);
      if (data.success) {
        alert("‚úÖ " + (data.mensaje || "Guardado correctamente"));
        formRegistro.reset();
        document.getElementById('fecha').value = new Date().toISOString().split('T')[0];
        setTimeout(sincronizarRegistros, 2000);
      } else {
        alert("‚ùå Error: " + (data.error || "Respuesta inesperada del servidor"));
      }
    })
    .catch(err => {
      console.error("Error:", err);
      alert("‚ùå Error al guardar el registro");
    });
}


    function renderizarRegistros() {
      listaRegistros.innerHTML = '';
      
      if (registros.length === 0) {
        listaRegistros.innerHTML = '<p style="text-align: center; color: #666;">No hay registros de mantenimiento</p>';
        return;
      }

      registros.forEach((registro) => {
        const li = document.createElement('li');
        li.className = 'registro-item';
        
        let statusClass = '';
        if (registro.estado === 'Pendiente') statusClass = 'status-pendiente';
        if (registro.estado === 'En progreso') statusClass = 'status-progreso';
        if (registro.estado === 'Finalizado') statusClass = 'status-finalizado';

        li.innerHTML = `
          <div class="registro-header">
            <div class="registro-title">${registro.tipo} - ${registro.placa}</div>
            <div class="registro-actions">
              <span class="status-badge ${statusClass}">${registro.estado}</span>
              <button class="edit-btn" data-id="${registro.id}">Editar</button>
              <button class="delete-btn" data-id="${registro.id}">Eliminar</button>
            </div>
          </div>
          <div class="registro-details">
            <div class="detail-item">
              <div class="detail-label">Tipo de Equipo</div>
              <div class="detail-value">${registro.tipo}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Marca</div>
              <div class="detail-value">${registro.marca}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Modelo</div>
              <div class="detail-value">${registro.modelo}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Serial</div>
              <div class="detail-value">${registro.serial}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Fecha</div>
              <div class="detail-value">${formatDate(registro.fecha)}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Placa/Identificacion</div>
              <div class="detail-value">${registro.placa}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">T√©cnico</div>
              <div class="detail-value">${registro.tecnico}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Tipo Mant.</div>
              <div class="detail-value">${registro.tipoMantenimiento}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Ubicaci√≥n</div>
              <div class="detail-value">${registro.ubicacion}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Centro Costo</div>
              <div class="detail-value">${registro.centroCosto}</div>
            </div>
           ${registro.urlTicket && registro.urlTicket.trim() !== '' ? `
             <div class="detail-item">
             <div class="detail-label">Ticket</div>
              <div class="detail-value"><a href="${registro.urlTicket}" target="_blank">üìéVer ticket</a></div>
              </div>` : ''}
            <div class="detail-item">
              <div class="detail-label">Registrado por</div>
              <div class="detail-value">${registro.usuarioRegistro || 'Sistema'}</div>
            </div>
          </div>
          ${registro.observaciones ? `
          <div class="detail-item" style="margin-top: 1rem;">
            <div class="detail-label">Observaciones</div>
            <div class="detail-value">${registro.observaciones}</div>
          </div>` : ''}
        `;
        
        listaRegistros.appendChild(li);
      });

     
      document.querySelectorAll('.edit-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const id = e.target.getAttribute('data-id');
          editarRegistro(id);
        });
      });

   document.querySelectorAll('.delete-btn').forEach(btn => {
  btn.addEventListener('click', (e) => {
    const id = e.target.getAttribute('data-id');
    eliminarRegistro(id);
  });
});

    }

    function buscarRegistros() {
     if (modoPendientes) {
  modoPendientes = false;
}

      const termino = buscarInput.value.toLowerCase();
      const desde = document.getElementById('filtro-desde').value;
      const hasta = document.getElementById('filtro-hasta').value;
      function exportarAExcel() {
  const resultados = document.querySelectorAll('#resultados .registro-item');
  if (resultados.length === 0) {
    alert('No hay resultados de b√∫squeda para exportar.');
    return;
  }

  const datosExportar = [];

  resultados.forEach(item => {
    const fila = {
      'Tipo de Equipo': '',
      'Placa': '',
      'Marca': '',
      'Modelo': '',
      'Serial': '',
      'Fecha': '',
      'T√©cnico': '',
      'Estado': '',
      'Ubicaci√≥n': '',
      'Centro de Costo': '',
      'Observaciones': '',
      'Ticket': '',
      'Registrado por': ''
    };

    const detalles = item.querySelectorAll('.detail-item');
    detalles.forEach(detalle => {
      const label = detalle.querySelector('.detail-label')?.textContent.trim().toLowerCase();
      const valor = detalle.querySelector('.detail-value')?.textContent.trim();

      if (!label) return;

      if (label.includes('tipo de equipo')) fila['Tipo de Equipo'] = valor;
      else if (label.includes('placa')) fila['Placa'] = valor;
      else if (label.includes('marca')) fila['Marca'] = valor;
      else if (label.includes('modelo')) fila['Modelo'] = valor;
      else if (label.includes('serial')) fila['Serial'] = valor;
      else if (label.includes('fecha')) fila['Fecha'] = valor;
      else if (label.includes('t√©cnico')) fila['T√©cnico'] = valor;
      else if (label.includes('ubicaci√≥n')) fila['Ubicaci√≥n'] = valor;
      else if (label.includes('centro')) fila['Centro de Costo'] = valor;
      else if (label.includes('observaciones')) fila['Observaciones'] = valor;
      else if (label.includes('ticket')) fila['Ticket'] = valor;
      else if (label.includes('registrado')) fila['Registrado por'] = valor;
    });

   
    fila['Estado'] = item.querySelector('.status-badge')?.textContent.trim() || '';

    datosExportar.push(fila);
  });

  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.json_to_sheet(datosExportar);
  XLSX.utils.book_append_sheet(wb, ws, 'Resultados');

  const fechaActual = new Date().toISOString().split('T')[0];
  XLSX.writeFile(wb, `resultados_busqueda_${fechaActual}.xlsx`);
}

      resultadosBusqueda.innerHTML = '';
      let resultados = registros.filter(registro => {
  const coincideTexto = 
    registro.placa.toLowerCase().includes(termino) || 
    registro.serial.toLowerCase().includes(termino) || 
    registro.tecnico.toLowerCase().includes(termino) ||
    (registro.usuarioRegistro && registro.usuarioRegistro.toLowerCase().includes(termino));

  if (!aplicarFiltroFecha || (!desde && !hasta)) {
    return coincideTexto;
  }

  const fechaRegistro = new Date(registro.fecha);
  const fechaDesde = new Date(desde);
  const fechaHasta = new Date(hasta);
  fechaHasta.setDate(fechaHasta.getDate() + 1); 

  const coincideFecha = fechaRegistro >= fechaDesde && fechaRegistro <= fechaHasta;
  return coincideTexto && coincideFecha;
});
aplicarFiltroFecha = false;

      
      if (resultados.length === 0) {
        resultadosBusqueda.innerHTML = '<p style="text-align: center; color: #666;">No se encontraron resultados</p>';
        return;
      }
      function filtrarPorFechas() {
  const desde = document.getElementById('filtro-desde').value;
  const hasta = document.getElementById('filtro-hasta').value;

  if (!desde || !hasta) {
    alert("‚ö†Ô∏è Por favor selecciona un rango de fechas v√°lido.");
    return;
  }

  const termino = buscarInput.value.toLowerCase();

  const fechaDesde = new Date(desde);
  const fechaHasta = new Date(hasta);
  fechaHasta.setDate(fechaHasta.getDate() + 1); 

  const resultados = registros.filter(registro => {
    const coincideTexto =
      registro.placa.toLowerCase().includes(termino) ||
      registro.serial.toLowerCase().includes(termino) ||
      registro.tecnico.toLowerCase().includes(termino) ||
      (registro.usuarioRegistro && registro.usuarioRegistro.toLowerCase().includes(termino));

    const fechaRegistro = new Date(registro.fecha);
    const coincideFecha = fechaRegistro >= fechaDesde && fechaRegistro <= fechaHasta;

    return coincideTexto && coincideFecha;
  });

  renderizarResultadosBusqueda(resultados);
}

      
      resultados.forEach(registro => {
        const li = document.createElement('li');
        li.className = 'registro-item';
        
        let statusClass = '';
        if (registro.estado === 'Pendiente') statusClass = 'status-pendiente';
        if (registro.estado === 'En progreso') statusClass = 'status-progreso';
        if (registro.estado === 'Finalizado') statusClass = 'status-finalizado';

        li.innerHTML = `
          <div class="registro-header">
            <div class="registro-title">${registro.tipo} - ${registro.placa}</div>
            <div class="registro-actions">
              <span class="status-badge ${statusClass}">${registro.estado}</span>
              <button class="edit-btn" data-id="${registro.id}">Editar</button>
              <button class="delete-btn" data-id="${registro.id}">Eliminar</button>
              <button class="history-btn" data-id="${registro.id}">Ver Historial</button>
                   </div>
                    </div>
                     <div class="registro-details">
                  <div class="detail-item">
                <div class="detail-label">Tipo de Equipo</div>
               <div class="detail-value">${registro.tipo}</div>
             </div>
            <div class="detail-item">
             <div class="detail-label">Marca</div>
                <div class="detail-value">${registro.marca}</div>
                 </div>
                  <div class="detail-item">
                   <div class="detail-label">Modelo</div>
                    <div class="detail-value">${registro.modelo}</div>
                 </div>
                <div class="detail-item">
              <div class="detail-label">Placa/Identificacion</div>
            <div class="detail-value">${registro.placa}</div>
          </div>
        <div class="detail-item">
       <div class="detail-label">Serial</div>
         <div class="detail-value">${registro.serial}</div>
          </div>
            <div class="detail-item">
             <div class="detail-label">Fecha</div>
              <div class="detail-value">${formatDate(registro.fecha)}</div>
                </div>
              <div class="detail-item">
            <div class="detail-label">T√©cnico</div>
            <div class="detail-value">${registro.tecnico}</div>
          </div> 
        <div class="detail-item">
      <div class="detail-label">Ubicaci√≥n</div>
        <div class="detail-value">${registro.ubicacion}</div>
         </div>
           <div class="detail-item">
            <div class="detail-label">Centro de Costo</div>
              <div class="detail-value">${registro.centroCosto}</div>
             </div>
            <div class="detail-item">
          <div class="detail-label">Observaciones</div>
        <div class="detail-value">${registro.observaciones || ''}</div>
        </div>
        ${registro.urlTicket ? `<div class="detail-item">
        <div class="detail-label">Ticket</div>
         <div class="detail-value"><a href="${registro.urlTicket}" target="_blank">üìéVer ticket</a></div>
          </div>` : ''}
            <div class="detail-item">
              <div class="detail-label">Registrado por</div>
              <div class="detail-value">${registro.usuarioRegistro || 'Sistema'}</div>
            </div>
          </div>
        `;
        
        resultadosBusqueda.appendChild(li);
      });
   document.querySelectorAll('.history-btn').forEach(btn => {
     btn.addEventListener('click', (e) => {
      const id = e.target.getAttribute('data-id');
       verHistorial(id);
  });
});
     
       document.querySelectorAll('.edit-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const id = e.target.getAttribute('data-id');
          editarRegistro(id);
        });
      });
      document.querySelectorAll('.delete-btn').forEach(btn => {
  btn.addEventListener('click', (e) => {
    const id = e.target.getAttribute('data-id');
    eliminarRegistro(id);
  });
});

    }

    function editarRegistro(id) {
  const r = registros.find(item => String(item.id) === String(id));
  if (!r) {
    console.warn('No encontr√© el registro con id:', id);
    alert('No se encontr√≥ el registro para editar.');
    return;
  }
  abrirModalEdicion(r);
}


function guardarEdicion(e) {
  e.preventDefault();

  const payload = {
    id:               document.getElementById('edit-indice').value,
    placa:            document.getElementById('edit-placa').value,
    serial:           document.getElementById('edit-serial').value,
    fecha:            document.getElementById('edit-fecha').value,
    tipo:             document.getElementById('edit-tipo').value,
    marca:            document.getElementById('edit-marca').value,
    modelo:           document.getElementById('edit-modelo').value,
    tecnico:          document.getElementById('edit-tecnico').value,
    tipo_mantenimiento: document.getElementById('edit-tipo-mantenimiento').value,
    estado:           document.getElementById('edit-estado').value,
    ubicacion:        document.getElementById('edit-ubicacion').value,
    centro_costo:     document.getElementById('edit-centro-costo').value,
    url_ticket:       document.getElementById('edit-url-ticket').value,
    observaciones:    document.getElementById('edit-observaciones').value
  };

  fetch(API_BASE + 'editar_registro.php', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  })
  .then(r => r.json())
  .then(d => {
    if (d.success) {
      alert('‚úÖ Actualizado');
      cerrarModal();
      setTimeout(sincronizarRegistros, 1000);
    } else {
      alert('‚ùå ' + (d.error || 'Error al actualizar'));
    }
  })
  .catch(err => {
    console.error(err);
    alert('‚ùå Error de red al actualizar');
  });
}


function eliminarRegistro(id) {
  if (!confirm('¬øEst√°s seguro de eliminar este registro?')) return;

 fetch(API_BASE + "eliminar_registro.php", {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({ id })
})
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      alert(data.mensaje || "‚úÖ Registro eliminado correctamente");
      sincronizarRegistros();
    } else {
      alert("‚ùå Error: " + (data.error || "No se pudo eliminar"));
    }
  })
  .catch(err => {
    console.error("Error al eliminar:", err);
    alert("‚ùå Error al eliminar el registro");
  });

}


    function cerrarModal() {
      modalEdicion.classList.remove('active');
    }

    function actualizarEstadisticas() {
      totalElement.textContent = registros.length;
      pendientesElement.textContent = registros.filter(r => r.estado === 'Pendiente').length;
      enProgresoElement.textContent = registros.filter(r => r.estado === 'En progreso').length;
      finalizadosElement.textContent = registros.filter(r => r.estado === 'Finalizado').length;
    }
  
    function formatDate(dateString) {
      const options = { year: 'numeric', month: 'short', day: 'numeric' };
      return new Date(dateString).toLocaleDateString('es-ES', options);
    }

    function exportarAExcel() {
  const resultados = document.querySelectorAll('#resultados .registro-item');
  if (resultados.length === 0) {
    alert('No hay resultados de b√∫squeda para exportar.');
    return;
  }

  const datosExportar = [];

  resultados.forEach(item => {
    const fila = {
      'Tipo de Equipo': '',
      'Placa': '',
      'Marca': '',
      'Modelo': '',
      'Serial': '',
      'Fecha': '',
      'T√©cnico': '',
      'Tipo de Mantenimiento': '',
      'Estado': '',
      'Ubicaci√≥n': '',
      'Centro de Costo': '',
      'Observaciones': '',
      'Ticket': '',
      'Registrado por': ''
    };

    const detalles = item.querySelectorAll('.detail-item');
    detalles.forEach(detalle => {
      const label = detalle.querySelector('.detail-label')?.textContent.trim().toLowerCase();
      const valor = detalle.querySelector('.detail-value')?.textContent.trim();

      if (!label) return;

      if (label.includes('tipo de equipo')) fila['Tipo de Equipo'] = valor;
      else if (label.includes('placa')) fila['Placa'] = valor;
      else if (label.includes('marca') && !label.includes('marca/modelo')) fila['Marca'] = valor;
      else if (label.includes('modelo')) fila['Modelo'] = valor;
      else if (label.includes('serial')) fila['Serial'] = valor;
      else if (label.includes('fecha')) fila['Fecha'] = valor;
      else if (label.includes('t√©cnico')) fila['T√©cnico'] = valor;
      else if (label.includes('tipo mant')) fila['Tipo de Mantenimiento'] = valor;
      else if (label.includes('ubicaci√≥n')) fila['Ubicaci√≥n'] = valor;
      else if (label.includes('centro')) fila['Centro de Costo'] = valor;
      else if (label.includes('observaciones')) fila['Observaciones'] = valor;
      else if (label.includes('ticket')) {
        const link = detalle.querySelector('a');
        fila['Ticket'] = link ? link.href : valor;
      }
      else if (label.includes('registrado')) fila['Registrado por'] = valor;
    });

    fila['Estado'] = item.querySelector('.status-badge')?.textContent.trim() || '';
    datosExportar.push(fila);
  });

  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.json_to_sheet(datosExportar);
  XLSX.utils.book_append_sheet(wb, ws, 'Resultados');

  const fechaActual = new Date().toISOString().split('T')[0];
  XLSX.writeFile(wb, `resultados_busqueda_${fechaActual}.xlsx`);
}


    window.addEventListener('click', (e) => {
      if (e.target === modalEdicion) {
        cerrarModal();
      }
    });

     function verHistorial(id) {
  // Busca el registro por ID ignorando tipos (string/number)
  const registro = registros.find(r => String(r.id) === String(id));
  if (!registro) {
    alert('‚ö†Ô∏è No se encontr√≥ el registro para mostrar historial.');
    return;
  }

  const placaBuscada = (registro.placa || '').trim();
  if (!placaBuscada) {
    alert('‚ö†Ô∏è Este registro no tiene placa. No es posible construir historial.');
    return;
  }

  // Filtra por la misma placa y ordena por fecha DESC
  const historiales = (registros || [])
    .filter(r => (r.placa || '').trim() === placaBuscada)
    .sort((a, b) => new Date(b.fecha || 0) - new Date(a.fecha || 0));

  const contenedor = document.getElementById('historial-contenido');
  if (!contenedor) {
    console.error('‚ùå No existe el contenedor #historial-contenido en el DOM.');
    return;
  }

  contenedor.innerHTML = '';

  if (historiales.length === 0) {
    contenedor.innerHTML = '<p style="color:#666;">No hay mantenimientos anteriores para esta placa.</p>';
  } else {
    historiales.forEach(item => {
      const statusClass =
        item.estado === 'Pendiente'   ? 'status-pendiente' :
        item.estado === 'En progreso' ? 'status-progreso'  :
        item.estado === 'Finalizado'  ? 'status-finalizado': '';

      const tipo            = item.tipo || '';
      const marca           = item.marca || '';
      const modelo          = item.modelo || '';
      const placa           = item.placa || '';
      const serial          = item.serial || '';
      const fecha           = item.fecha ? formatDate(item.fecha) : '';
      const tecnico         = item.tecnico || '';
      const tipoMant        = item.tipoMantenimiento || item.tipo_mantenimiento || '';
      const ubicacion       = item.ubicacion || '';
      const centroCosto     = item.centroCosto || item.centro_costo || '';
      const observaciones   = item.observaciones || 'N/A';
      const usuarioRegistro = item.usuarioRegistro || 'Sistema';

      const div = document.createElement('div');
      div.className = 'registro-item';
      div.innerHTML = `
        <div class="registro-header">
          <div class="registro-title">${tipo} - ${placa}</div>
          <div class="registro-actions">
            <span class="status-badge ${statusClass}">${item.estado || ''}</span>
          </div>
        </div>
        <div class="registro-details">
          <div class="detail-item"><div class="detail-label">Tipo de Equipo</div><div class="detail-value">${tipo}</div></div>
          <div class="detail-item"><div class="detail-label">Marca</div><div class="detail-value">${marca}</div></div>
          <div class="detail-item"><div class="detail-label">Modelo</div><div class="detail-value">${modelo}</div></div>
          <div class="detail-item"><div class="detail-label">Placa/Identificaci√≥n</div><div class="detail-value">${placa}</div></div>
          <div class="detail-item"><div class="detail-label">Serial</div><div class="detail-value">${serial}</div></div>
          <div class="detail-item"><div class="detail-label">Fecha</div><div class="detail-value">${fecha}</div></div>
          <div class="detail-item"><div class="detail-label">T√©cnico</div><div class="detail-value">${tecnico}</div></div>
          <div class="detail-item"><div class="detail-label">Tipo Mantenimiento</div><div class="detail-value">${tipoMant}</div></div>
          <div class="detail-item"><div class="detail-label">Ubicaci√≥n</div><div class="detail-value">${ubicacion}</div></div>
          <div class="detail-item"><div class="detail-label">Centro de Costo</div><div class="detail-value">${centroCosto}</div></div>
          <div class="detail-item"><div class="detail-label">Observaciones</div><div class="detail-value">${observaciones}</div></div>
          <div class="detail-item"><div class="detail-label">Registrado por</div><div class="detail-value">${usuarioRegistro}</div></div>
        </div>
      `;
      contenedor.appendChild(div);
    });
  }

  // Abre el modal
  const modal = document.getElementById('modal-historial');
  if (modal) modal.classList.add('active');
}

// (opcional) exp√≥rtala global
window.verHistorial = verHistorial;
function cerrarModalHistorial() {
  const modal = document.getElementById('modal-historial');
  if (modal) modal.classList.remove('active');
}


let modoPendientes = false; 
let aplicarFiltroFecha = false;

function verPendientes() {
  modoPendientes = true;
  cambiarSeccion('buscar');
  document.getElementById('buscar-input').value = '';
document.getElementById('filtro-desde').value = '';
document.getElementById('filtro-hasta').value = '';

  resultadosBusqueda.innerHTML = '';

  const resultados = registros.filter(r => r.estado === 'Pendiente');

  if (resultados.length === 0) {
    resultadosBusqueda.innerHTML = '<p class="mensaje-vacio">‚ö†Ô∏è No hay registros pendientes</p>';
    return;
  }

  resultados.forEach(registro => {
  const li = document.createElement('li');
  li.className = 'registro-item';

  let statusClass = '';
  if (registro.estado === 'Pendiente') statusClass = 'status-pendiente';
  if (registro.estado === 'En progreso') statusClass = 'status-progreso';
  if (registro.estado === 'Finalizado') statusClass = 'status-finalizado';

li.innerHTML = `
  <div class="registro-header">
    <div class="registro-title">${registro.tipo} - ${registro.placa}</div>
    <div class="registro-actions">
      <span class="status-badge ${statusClass}">${registro.estado}</span>
      <button class="edit-btn" data-id="${registro.id}">Editar</button>
      <button class="delete-btn" data-id="${registro.id}">Eliminar</button>
      <button class="history-btn" data-id="${registro.id}">Ver Historial</button>
    </div>
  </div>
  <div class="registro-details">
    <div class="detail-item"><div class="detail-label">Tipo de Equipo</div><div class="detail-value">${registro.tipo}</div></div>
    <div class="detail-item"><div class="detail-label">Marca</div><div class="detail-value">${registro.marca}</div></div>
    <div class="detail-item"><div class="detail-label">Modelo</div><div class="detail-value">${registro.modelo}</div></div>
    <div class="detail-item"><div class="detail-label">Placa/Identificacion</div><div class="detail-value">${registro.placa}</div></div>
    <div class="detail-item"><div class="detail-label">Serial</div><div class="detail-value">${registro.serial}</div></div>
    <div class="detail-item"><div class="detail-label">Fecha</div><div class="detail-value">${formatDate(registro.fecha)}</div></div>
    <div class="detail-item"><div class="detail-label">T√©cnico</div><div class="detail-value">${registro.tecnico}</div></div>
    <div class="detail-item"><div class="detail-label">Tipo de Mantenimiento</div><div class="detail-value">${registro.tipoMantenimiento}</div></div>
    <div class="detail-item"><div class="detail-label">Ubicaci√≥n</div><div class="detail-value">${registro.ubicacion}</div></div>
    <div class="detail-item"><div class="detail-label">Centro de Costo</div><div class="detail-value">${registro.centroCosto}</div></div>
    ${registro.observaciones ? `<div class="detail-item"><div class="detail-label">Observaciones</div><div class="detail-value">${registro.observaciones}</div></div>` : ''}
    ${registro.urlTicket ? `<div class="detail-item"><div class="detail-label">Ticket</div><div class="detail-value"><a href="${registro.urlTicket}" target="_blank">üìéVer ticket</a></div></div>` : ''}
    <div class="detail-item"><div class="detail-label">Registrado por</div><div class="detail-value">${registro.usuarioRegistro || 'Sistema'}</div></div>
  </div>
`;


  resultadosBusqueda.appendChild(li);
 
document.querySelectorAll('.edit-btn').forEach(btn => {
  btn.addEventListener('click', (e) => {
    const id = e.target.getAttribute('data-id');
    editarRegistro(id);
  });
});

document.querySelectorAll('.delete-btn').forEach(btn => {
  btn.addEventListener('click', (e) => {
    const id = e.target.getAttribute('data-id');
    eliminarRegistro(id);
  });
});

document.querySelectorAll('.history-btn').forEach(btn => {
  btn.addEventListener('click', (e) => {
    const id = e.target.getAttribute('data-id');
    verHistorial(id);
  });
});

});
}
function verEnProgreso() {
  modoPendientes = true;
  cambiarSeccion('buscar');
  document.getElementById('buscar-input').value = '';
  document.getElementById('filtro-desde').value = '';
  document.getElementById('filtro-hasta').value = '';

  resultadosBusqueda.innerHTML = '';

  const resultados = registros.filter(r => r.estado === 'En progreso');

  if (resultados.length === 0) {
    resultadosBusqueda.innerHTML = '<p class="mensaje-vacio">‚ö†Ô∏è No hay registros en Progreso</p>';
    return;
  }

  resultados.forEach(registro => {
    const li = document.createElement('li');
    li.className = 'registro-item';

    let statusClass = 'status-progreso';

    li.innerHTML = `
      <div class="registro-header">
        <div class="registro-title">${registro.tipo} - ${registro.placa}</div>
        <div class="registro-actions">
          <span class="status-badge ${statusClass}">${registro.estado}</span>
          <button class="edit-btn" data-id="${registro.id}">Editar</button>
          <button class="delete-btn" data-id="${registro.id}">Eliminar</button>
          <button class="history-btn" data-id="${registro.id}">Ver Historial</button>
        </div>
      </div>
      <div class="registro-details">
        <div class="detail-item"><div class="detail-label">Tipo de Equipo</div><div class="detail-value">${registro.tipo}</div></div>
        <div class="detail-item"><div class="detail-label">Marca</div><div class="detail-value">${registro.marca}</div></div>
         <div class="detail-item"><div class="detail-label">Modelo</div><div class="detail-value">${registro.modelo}</div></div>
        <div class="detail-item"><div class="detail-label">Placa/Identificacion</div><div class="detail-value">${registro.placa}</div></div>
        <div class="detail-item"><div class="detail-label">Serial</div><div class="detail-value">${registro.serial}</div></div>
        <div class="detail-item"><div class="detail-label">Fecha</div><div class="detail-value">${formatDate(registro.fecha)}</div></div>
        <div class="detail-item"><div class="detail-label">T√©cnico</div><div class="detail-value">${registro.tecnico}</div></div>
        <div class="detail-item"><div class="detail-label">Tipo de Mantenimiento</div><div class="detail-value">${registro.tipoMantenimiento}</div></div>
        <div class="detail-item"><div class="detail-label">Ubicaci√≥n</div><div class="detail-value">${registro.ubicacion}</div></div>
        <div class="detail-item"><div class="detail-label">Centro de Costo</div><div class="detail-value">${registro.centroCosto}</div></div>
        ${registro.observaciones ? `<div class="detail-item"><div class="detail-label">Observaciones</div><div class="detail-value">${registro.observaciones}</div></div>` : ''}
        ${registro.urlTicket ? `<div class="detail-item"><div class="detail-label">Ticket</div><div class="detail-value"><a href="${registro.urlTicket}" target="_blank">üìéVer ticket</a></div></div>` : ''}
        <div class="detail-item"><div class="detail-label">Registrado por</div><div class="detail-value">${registro.usuarioRegistro || 'Sistema'}</div></div>
      </div>
    `;
    resultadosBusqueda.appendChild(li);
    
document.querySelectorAll('.edit-btn').forEach(btn => {
  btn.addEventListener('click', (e) => {
    const id = e.target.getAttribute('data-id');
    editarRegistro(id);
  });
});

document.querySelectorAll('.delete-btn').forEach(btn => {
  btn.addEventListener('click', (e) => {
    const id = e.target.getAttribute('data-id');
    eliminarRegistro(id);
  });
});

document.querySelectorAll('.history-btn').forEach(btn => {
  btn.addEventListener('click', (e) => {
    const id = e.target.getAttribute('data-id');
    verHistorial(id);
  });
});

  });
}

function verFinalizados() {
  modoPendientes = true;
  cambiarSeccion('buscar');
  document.getElementById('buscar-input').value = '';
  document.getElementById('filtro-desde').value = '';
  document.getElementById('filtro-hasta').value = '';

  resultadosBusqueda.innerHTML = '';

  const resultados = registros.filter(r => r.estado === 'Finalizado');

  if (resultados.length === 0) {
    resultadosBusqueda.innerHTML = '<p class="mensaje-vacio">‚ö†Ô∏è No hay registros Finalizados</p>';

    return;
  }

  resultados.forEach(registro => {
    const li = document.createElement('li');
    li.className = 'registro-item';

    let statusClass = 'status-finalizado';

    li.innerHTML = `
      <div class="registro-header">
        <div class="registro-title">${registro.tipo} - ${registro.placa}</div>
        <div class="registro-actions">
          <span class="status-badge ${statusClass}">${registro.estado}</span>
          <button class="edit-btn" data-id="${registro.id}">Editar</button>
          <button class="delete-btn" data-id="${registro.id}">Eliminar</button>
          <button class="history-btn" data-id="${registro.id}">Ver Historial</button>
        </div>
      </div>
      <div class="registro-details">
        <div class="detail-item"><div class="detail-label">Tipo de Equipo</div><div class="detail-value">${registro.tipo}</div></div>
        <div class="detail-item"><div class="detail-label">Marca</div><div class="detail-value">${registro.marca}</div></div>
        <div class="detail-item"><div class="detail-label">Modelo</div><div class="detail-value">${registro.modelo}</div></div>
        <div class="detail-item"><div class="detail-label">Placa/Identificacion</div><div class="detail-value">${registro.placa}</div></div>
        <div class="detail-item"><div class="detail-label">Serial</div><div class="detail-value">${registro.serial}</div></div>
        <div class="detail-item"><div class="detail-label">Fecha</div><div class="detail-value">${formatDate(registro.fecha)}</div></div>
        <div class="detail-item"><div class="detail-label">T√©cnico</div><div class="detail-value">${registro.tecnico}</div></div>
        <div class="detail-item"><div class="detail-label">Tipo de Mantenimiento</div><div class="detail-value">${registro.tipoMantenimiento}</div></div>
        <div class="detail-item"><div class="detail-label">Ubicaci√≥n</div><div class="detail-value">${registro.ubicacion}</div></div>
        <div class="detail-item"><div class="detail-label">Centro de Costo</div><div class="detail-value">${registro.centroCosto}</div></div>
        ${registro.observaciones ? `<div class="detail-item"><div class="detail-label">Observaciones</div><div class="detail-value">${registro.observaciones}</div></div>` : ''}
        ${registro.urlTicket ? `<div class="detail-item"><div class="detail-label">Ticket</div><div class="detail-value"><a href="${registro.urlTicket}" target="_blank">üìéVer ticket</a></div></div>` : ''}
        <div class="detail-item"><div class="detail-label">Registrado por</div><div class="detail-value">${registro.usuarioRegistro || 'Sistema'}</div></div>
      </div>
    `;
    resultadosBusqueda.appendChild(li);
    
document.querySelectorAll('.edit-btn').forEach(btn => {
  btn.addEventListener('click', (e) => {
    const id = e.target.getAttribute('data-id');
    editarRegistro(id);
  });
});

document.querySelectorAll('.delete-btn').forEach(btn => {
  btn.addEventListener('click', (e) => {
    const id = e.target.getAttribute('data-id');
    eliminarRegistro(id);
  });
});

document.querySelectorAll('.history-btn').forEach(btn => {
  btn.addEventListener('click', (e) => {
    const id = e.target.getAttribute('data-id');
    verHistorial(id);
  });
});

  });
}
function verTodosLosRegistros() {
  modoPendientes = false;
  cambiarSeccion('buscar');

  
  document.getElementById('buscar-input').value = '';
  document.getElementById('filtro-desde').value = '';
  document.getElementById('filtro-hasta').value = '';
  resultadosBusqueda.innerHTML = '';

  if (registros.length === 0) {
    resultadosBusqueda.innerHTML = '<p class="mensaje-vacio">‚ö†Ô∏è No hay registros disponibles</p>';
    return;
  }

  registros.forEach(registro => {
    const li = document.createElement('li');
    li.className = 'registro-item';

    let statusClass = '';
    if (registro.estado === 'Pendiente') statusClass = 'status-pendiente';
    if (registro.estado === 'En progreso') statusClass = 'status-progreso';
    if (registro.estado === 'Finalizado') statusClass = 'status-finalizado';

    li.innerHTML = `
      <div class="registro-header">
        <div class="registro-title">${registro.tipo} - ${registro.placa}</div>
        <div class="registro-actions">
          <span class="status-badge ${statusClass}">${registro.estado}</span>
          <button class="edit-btn" data-id="${registro.id}">Editar</button>
          <button class="delete-btn" data-id="${registro.id}">Eliminar</button>
          <button class="history-btn" data-id="${registro.id}">Ver Historial</button>
        </div>
      </div>
      <div class="registro-details">
        <div class="detail-item"><div class="detail-label">Tipo de Equipo</div><div class="detail-value">${registro.tipo}</div></div>
        <div class="detail-item"><div class="detail-label">Marca</div><div class="detail-value">${registro.marca}</div></div>
        <div class="detail-item"><div class="detail-label">Modelo</div><div class="detail-value">${registro.modelo}</div></div>
        <div class="detail-item"><div class="detail-label">Placa/Identificacion</div><div class="detail-value">${registro.placa}</div></div>
        <div class="detail-item"><div class="detail-label">Serial</div><div class="detail-value">${registro.serial}</div></div>
        <div class="detail-item"><div class="detail-label">Fecha</div><div class="detail-value">${formatDate(registro.fecha)}</div></div>
        <div class="detail-item"><div class="detail-label">T√©cnico</div><div class="detail-value">${registro.tecnico}</div></div>
        <div class="detail-item"><div class="detail-label">Tipo de Mantenimiento</div><div class="detail-value">${registro.tipoMantenimiento}</div></div>
        <div class="detail-item"><div class="detail-label">Ubicaci√≥n</div><div class="detail-value">${registro.ubicacion}</div></div>
        <div class="detail-item"><div class="detail-label">Centro de Costo</div><div class="detail-value">${registro.centroCosto}</div></div>
        ${registro.observaciones ? `<div class="detail-item"><div class="detail-label">Observaciones</div><div class="detail-value">${registro.observaciones}</div></div>` : ''}
        ${registro.urlTicket ? `<div class="detail-item"><div class="detail-label">Ticket</div><div class="detail-value"><a href="${registro.urlTicket}" target="_blank">üîó Ver ticket</a></div></div>` : ''}
        <div class="detail-item"><div class="detail-label">Registrado por</div><div class="detail-value">${registro.usuarioRegistro || 'Sistema'}</div></div>
      </div>
    `;

    resultadosBusqueda.appendChild(li);
  });

 
  document.querySelectorAll('.edit-btn').forEach(btn => {
    btn.addEventListener('click', (e) => editarRegistro(e.target.dataset.id));
  });

  document.querySelectorAll('.delete-btn').forEach(btn => {
    btn.addEventListener('click', (e) => eliminarRegistro(e.target.dataset.id));
  });

  document.querySelectorAll('.history-btn').forEach(btn => {
    btn.addEventListener('click', (e) => verHistorial(e.target.dataset.id));
  });
}

  </script>
 <script>
  window.addEventListener('DOMContentLoaded', () => {
    const alerta = document.getElementById('alerta-sistema');

    
    alerta.classList.remove('alerta-oculta');
    alerta.style.display = 'block';

    
    const cicloAlerta = () => {
      
      alerta.classList.remove('alerta-oculta');
      alerta.classList.add('visible');

    
      const sonido = document.getElementById('error-sound');
      if (sonido) {
        sonido.currentTime = 0;
        sonido.play();
      }

      
      setTimeout(() => {
        alerta.classList.remove('visible');
        alerta.classList.add('alerta-oculta');

        
        setTimeout(cicloAlerta, 4000);
      }, 5000);
    };

   
    cicloAlerta();
  });
</script>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const emoji = document.getElementById("emoji-rebotando");
    const box = document.querySelector(".login-box");

    let posX = 50;
    let posY = 50;
    let velX = 2;
    let velY = 2;

    function moverEmoji() {
      const boxWidth = box.clientWidth;
      const boxHeight = box.clientHeight;
      const emojiWidth = emoji.offsetWidth;
      const emojiHeight = emoji.offsetHeight;

      posX += velX;
      posY += velY;

      if (posX <= 0 || posX + emojiWidth >= boxWidth) velX *= -1;
      if (posY <= 0 || posY + emojiHeight >= boxHeight) velY *= -1;

      emoji.style.left = `${posX}px`;
      emoji.style.top = `${posY}px`;

      requestAnimationFrame(moverEmoji);
    }

    moverEmoji();
  });
</script>


<div class="modal" id="modal-historial">
  <div class="modal-content">
    <button type="button" class="close-modal-historial" aria-label="Cerrar">
  <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="white" viewBox="0 0 24 24">
    <circle cx="12" cy="12" r="12" fill="#e74c3c"/>
    <path d="M15 9l-6 6M9 9l6 6" stroke="white" stroke-width="2" stroke-linecap="round"/>
  </svg>
</button>

  

<div id="historial-contenido"></div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const selectsDinamicos = {
    tipo: "listar_tipo_equipo.php",
    marca: "listar_marcas.php",
    modelo: "listar_modelos.php",
    tecnico: "listar_tecnicos.php",
    tipo_mantenimiento: "listar_tipos_mantenimiento.php",
    estado: "listar_estados.php",
    ubicacion: "listar_ubicaciones.php"
  };

  for (const [id, endpoint] of Object.entries(selectsDinamicos)) {
    const select = document.getElementById(id);
    if (!select) continue;

    fetch(`http://10.110.6.148/mantenimientos/${endpoint}`)

      .then(res => res.json())
      .then(data => {
        select.innerHTML = '';
        const placeholder = new Option("Seleccionar...", "", true, true);
        placeholder.disabled = true;
        select.appendChild(placeholder);

        data.forEach(valor => select.appendChild(new Option(valor, valor)));

        if (!select.classList.contains("choices-initialized")) {
          new Choices(select, {
            placeholderValue: 'Seleccionar...',
            searchEnabled: true,
            removeItemButton: true,
            shouldSort: false
          });
          select.classList.add("choices-initialized");
        }
      })
      .catch(err => console.error(`‚ùå Error al cargar ${id}:`, err));
  }
});


</script>
<script>

function guardarSesion({ usuario, role, sede_id, sede_nombre }) {
  sessionStorage.setItem("usuario", usuario || "");
  sessionStorage.setItem("role", (role || "").toLowerCase() === "admin" ? "admin" : "user");
  sessionStorage.setItem("sede_id", (sede_id ?? "").toString());
  sessionStorage.setItem("sede_nombre", sede_nombre || "");
}

function limpiarSesion() {
  sessionStorage.removeItem("usuario");
  sessionStorage.removeItem("role");
  sessionStorage.removeItem("sede_id");
  sessionStorage.removeItem("sede_nombre");
  sessionStorage.removeItem("isLoggedIn"); 
}


function applyVideoBaseStyles(v) {
  if (!v) return;
  v.style.position  = "fixed";
  v.style.top       = "0";
  v.style.left      = "0";
  v.style.width     = "100vw";
  v.style.height    = "100vh";
  v.style.objectFit = "cover";
  v.style.zIndex    = "-1"; 
}

function resurrectVideoIfMissing() {
  let v = document.getElementById("video-fondo");
  if (v) return v;

  const login = document.getElementById("login");
  v = document.createElement("video");
  v.id = "video-fondo";
  v.autoplay = true;
  v.muted = true;
  v.loop = true;
  v.playsInline = true;

  const source = document.createElement("source");
  source.src = "VIDEO/VIDEO-MP4.mp4";
  source.type = "video/mp4";
  v.appendChild(source);

  const where = login?.parentNode || document.body;
  where.insertBefore(v, login || where.firstChild);
  return v;
}

function showVideoBackground() {
  const v = resurrectVideoIfMissing();
  applyVideoBaseStyles(v);
  v.style.removeProperty("display");
  v.style.display = "block";
  v.muted = true;
  v.playsInline = true;
  try { v.currentTime = 0; } catch (_) {}
  try { v.load(); } catch (_) {}
  const p = v.play?.();
  if (p && typeof p.catch === "function") p.catch(() => {});
}

function hideVideoBackground() {
  const v = document.getElementById("video-fondo");
  if (!v) return;
  try { v.pause?.(); } catch (_) {}
  v.style.display = "none";
}


function setBadgeSede({ role, sedeNombre }) {
  const badge = document.getElementById("nombreSede");
  if (!badge) return;
  const normalizar = (txt) => {
    if (!txt) return "";
    const t = (txt || "").toLowerCase();
    if (t.includes("meta")) return "Regional Meta_Fincas";
    if (t.includes("bogota") || t.includes("bogot√°")) return "Regional Bogot√°";
    if (t.includes("santander")) return "Regional Santander";
   if (t.includes("frigor") || t.includes("cundinamarca")) return "Regional Frigor√≠fico";

    return txt;
  };
  const bonito = normalizar(sedeNombre);
  const esAdmin = (role || "").toLowerCase() === "admin";
  badge.textContent = esAdmin
    ? `Administrador ‚Äî ${bonito || "Regional Meta_Fincas"}`
    : `${bonito || "Sin sede"}`;
}

function renderSedeDesdeSesion() {
  setBadgeSede({
    role: sessionStorage.getItem("role") || "",
    sedeNombre: sessionStorage.getItem("sede_nombre") || ""
  });
}


function mostrarApp() {
  document.getElementById("login")?.classList.add("oculto");
  document.getElementById("app")?.classList.remove("oculto");
  
  hideVideoBackground();
}

function mostrarLogin() {
  document.getElementById("app")?.classList.add("oculto");
  document.getElementById("login")?.classList.remove("oculto");
  
  showVideoBackground();
}


document.addEventListener("DOMContentLoaded", () => {
 
  const v0 = resurrectVideoIfMissing();
  applyVideoBaseStyles(v0);

  
  const qs = new URLSearchParams(location.search);
  if (qs.has("logout")) {
    
    limpiarSesion();
    showVideoBackground();

    const login = document.getElementById("login");
    const app   = document.getElementById("app");
    if (app)   { app.classList.add("oculto"); app.style.display = "none"; }
    if (login) { login.classList.remove("oculto"); login.style.display = "flex"; }

    
    history.replaceState({}, "", location.pathname);
  }

  
  if (sessionStorage.getItem("usuario")) {
    mostrarApp();
    renderSedeDesdeSesion();
  } else {
    mostrarLogin();
  }

 
  const form = document.getElementById("login-form");
  form?.addEventListener("submit", async (e) => {
    e.preventDefault();
    const usuario = document.getElementById("usuario").value.trim();
    const clave   = document.getElementById("clave").value;
    const errorBox = document.getElementById("error-login");
    if (errorBox) { errorBox.textContent = ""; errorBox.classList.add("oculto"); }

    try {
      const resp = await fetch("validar_login.php", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ usuario, clave })
      });
      const data = await resp.json();

      if (data?.success) {
        const role = data.role || "user";
        const sede_nombre_calc =
          data.sede_nombre || (String(role).toLowerCase() === "admin" ? "Regional Meta_Fincas" : "");

        guardarSesion({
          usuario,
          role,
          sede_id: data.sede_id,
          sede_nombre: sede_nombre_calc
        });

     
        mostrarApp();
        setBadgeSede({ role, sedeNombre: sede_nombre_calc });
      } else {
        const msg = data?.error || "Usuario o contrase√±a no v√°lidos";
        if (errorBox) { errorBox.textContent = msg; errorBox.classList.remove("oculto"); }
        else { alert(msg); }
      }
    } catch (err) {
      console.error("Error de login:", err);
      if (errorBox) { errorBox.textContent = "Error de conexi√≥n"; errorBox.classList.remove("oculto"); }
      else { alert("Error de conexi√≥n"); }
    }
  });

  
  document.getElementById("btn-logout")?.addEventListener("click", () => {
    window.location.href = "logout.php";
  });

  
  document.addEventListener("visibilitychange", () => {
    if (document.visibilityState === "visible" && !sessionStorage.getItem("usuario")) {
      showVideoBackground();
    }
  });
});
</script>

<script>
// Cerrar modal de historial de forma centralizada
function cerrarModalHistorial() {
  const modal = document.getElementById('modal-historial');
  if (modal) modal.classList.remove('active');
}

// 1) Click en el bot√≥n rojo ‚ùå dentro del modal
document.addEventListener('click', (e) => {
  if (e.target.closest('.close-modal-historial')) {
    e.preventDefault();
    cerrarModalHistorial();
  }
});

// 2) Click en el overlay (fuera del .modal-content)
document.addEventListener('click', (e) => {
  const modal = document.getElementById('modal-historial');
  if (!modal) return;
  if (modal.classList.contains('active') && e.target === modal) {
    cerrarModalHistorial();
  }
});

// 3) Tecla ESC
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') cerrarModalHistorial();
});

// 4) Bot√≥n "Salir" dentro del modal (evita overlay sobre el bot√≥n global)
document.addEventListener('click', (e) => {
  if (e.target && e.target.id === 'logout-desde-historial') {
    // Cierra el modal
    cerrarModalHistorial();

    // Reutiliza tu flujo actual de logout
    const logoutBtn = document.getElementById('btn-logout');
    if (logoutBtn) {
      logoutBtn.click(); // usa el listener ya configurado en tu app
    } else {
      // Fallback por si no existe el bot√≥n
      window.location.href = "logout.php";
    }
  }
});
</script>



</body>
</html>